# TÀI LIỆU BẢO VỆ ĐỒ ÁN: HỆ THỐNG ĐĂNG KÝ HỌC PHẦN PHÂN TÁN

## 1. Tổng quan & Tính Phân Tán (Overview & Distribution)

### Hệ thống này phân tán ở đâu? (Where is the distribution?)
Dự án được xây dựng theo mô hình **Client-Server phân tán**, trong đó:
1.  **Phân tán về Xử lý (Processing Distribution)**:
    -   **Client**: Chạy trên máy của sinh viên (hoặc nhiều terminal khác nhau). Chịu trách nhiệm về giao diện (UI) và nhận input.
    -   **Server**: Chạy trên một máy chủ trung tâm (hoặc port riêng). Chịu trách nhiệm xử lý logic nghiệp vụ, đồng bộ hóa và bảo vệ dữ liệu.
    -   Hai thành phần này giao tiếp qua môi trường mạng (Network) bằng **Socket TCP/IP**.
2.  **Đa luồng & Đa người dùng (Concurrency)**:
    -   Server có khả năng phục vụ nhiều Client cùng một lúc nhờ cơ chế **Multithreading** (Mỗi kết nối client được server tạo một `ClientThread` riêng biệt để xử lý).

### Kiến trúc Tổng thể (Architecture)
Hệ thống tuân thủ **Kiến trúc Phân tầng (Layered Architecture)** để đảm bảo tính tách biệt trách nhiệm (Separation of Concerns).

```mermaid
graph TD
    User((User/Student)) <--> ClientUI[Client Presentation Layer\n(Console UI)]
    ClientUI <--> ClientNet[Client Network Layer\n(Socket Stub)]
    ClientNet -- TCP/IP Protocol (CMD|Args) --> ServerNet[Server Network Layer\n(Listener & Thread Dispatcher)]
    ServerNet <--> Controller[Controller Layer\n(Request Handler)]
    Controller <--> DAL[Data Access Layer\n(Database Manager)]
    DAL -- SQL --> MySQL[(MySQL Database)]
```

---

## 2. Chi tiết Kiến Trúc (Architectural Details)

### A. Phí Client (Client Side)
Client được thiết kế "mỏng" (Thin Client), không chứa logic nghiệp vụ phức tạp.
1.  **Presentation Layer (`client.py`)**:
    -   Hiển thị menu, bảng danh sách môn học.
    -   Nhận input từ người dùng.
    -   Không truy cập trực tiếp Database.
2.  **Network Stub (`network_client.py`)**:
    -   Đóng gói yêu cầu thành chuỗi (ví dụ: `LOGIN|user1|123`).
    -   Gửi qua Socket và chờ nhận phản hồi từ Server.

### B. Phía Server (Server Side)
Server là nơi tập trung xử lý (Centralized Processing).
1.  **Network Layer (`server.py`)**:
    -   Mở Port `8888`.
    -   Lắng nghe kết nối (`listen`).
    -   Khi có Client điều phối vào một luồng riêng (`ClientThread`).
2.  **Controller Layer (`request_handler.py`)**:
    -   Phân tích gói tin (Parsing based on `|` delimiter).
    -   Điều hướng lệnh: `LOGIN`, `REGISTER`, `LIST`... đến hàm xử lý tương ứng.
3.  **Data Access Layer - DAO (`database_manager.py`)**:
    -   Chứa toàn bộ câu lệnh SQL.
    -   Quản lý kết nối Database và Transaction.

---

## 3. Giao thức Giao tiếp (Communication Protocol)

Hệ thống định nghĩa một giao thức tùy biến (Custom Protocol) đơn giản dạng văn bản (Text-based):

**Định dạng**: `COMMAND|ARG1|ARG2...`

| Lệnh (Command) | Tham số (Args) | Mô tả | Phản hồi mẫu (Response) |
| :--- | :--- | :--- | :--- |
| `LOGIN` | `User`|`Pass` | Đăng nhập hệ thống | `OK|Success` hoặc `ERR|Invalid...` |
| `LIST` | *(None)* | Lấy danh sách lớp học phần | `OK|[{...JSON...}]` |
| `REGISTER` | `SectionID` | Đăng ký môn học | `OK|Registration Successful` |
| `MY_COURSES` | *(None)* | Xem TKB cá nhân | `OK|[{...JSON...}]` |

---

## 4. Cơ chế Đồng bộ & Chống Xung đột (Concurrency Control)

Đây là phần quan trọng nhất của hệ thống phân tán để đảm bảo tính đúng đắn của dữ liệu (Consistency).

**Vấn đề**:
Giả sử lớp học chỉ còn **1 chỗ trống**. Hai sinh viên A và B cùng nhấn "Đăng ký" tại **chính xác cùng một thời điểm**. Nếu không xử lý tốt, cả hai đều đăng ký thành công -> Lớp học bị quá tải (Overfill) -> Sai dữ liệu.

**Giải pháp trong dự án**:
Sử dụng **Pessimistic Locking** (Khóa bi quan) với MySQL Transaction.

Trong file `database_manager.py`, hàm `register_student`:

1.  **Start Transaction**: `cnx.start_transaction()`
2.  **Locking Read**:
    ```python
    SELECT ... FROM sections WHERE id = %s FOR UPDATE
    ```
    Câu lệnh `FOR UPDATE` sẽ **khóa** dòng dữ liệu của lớp học đó lại.
3.  **Check Condition**:
    -   Nếu Client A đã lock, Client B buộc phải **chờ** (wait) cho đến khi A xong (commit/rollback).
    -   Khi A đăng ký xong (số chỗ đã giảm), B mới được đọc. Lúc này B sẽ thấy lớp đã đầy -> Báo lỗi "Class is FULL".
4.  **Commit**: Lưu thay đổi và giải phóng khóa.

---

## 5. Công nghệ sử dụng (Tech Stack)

*   **Ngôn ngữ**: Python 3.x
*   **Database**: MySQL (Relational DB)
*   **Thu viện**:
    *   `socket`: Lập trình mạng mức thấp.
    *   `threading`: Xử lý đa luồng.
    *   `mysql-connector-python`: Kết nối CSDL.
*   **Giao diện**: Console (CLI) - tập trung vào logic phân tán hơn là đồ họa.
